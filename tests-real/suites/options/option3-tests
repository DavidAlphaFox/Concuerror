#!/bin/bash

. header

print_blue "$0"

testing "Excluding works minimally"
concuerror_console -f exclude_modules/test.erl -f exclude_modules/excluded.erl -x excluded -m test
consolehas "1/1"

testing "Mixed case options are ok"
concuerror_console --VeRsIoN
consolehas "Concuerror v"

testing "Tip for attributes"
concuerror_console -a 1000 --assume_racing -d 5000 --ignore_error crash deadlock -i 6000 -k -f foo.erl
consolehas "help attributes"

testing "Help for attributes"
concuerror_console -h attributes
consolehas "the following attributes in the module"

testing "Disable output"
rm -rf $Out
concuerror_console -f foo.erl --no_output
consolehas "No output report will be generated"
testing "... and file doesn't exist."
if [ ! -f "$Out" ]; then
    good
else
    exit 1
fi

testing "Total silence"
rm -rf $Out
concuerror_console -f foo.erl --no_output -q
! consolehas "*"
! outputhas "*"

testing "Nonexistent input file"
! concuerror_console -f nonexistent
consolehas "Error: nonexistent is not a .erl or .beam file"

testing "Bad .erl input file"
! concuerror_console -f bad.erl > /dev/null
consolehas "Error: could not compile bad.erl (try to add the .beam file instead)"

testing "BEAM input file"
rm -f foo.beam
erlc foo.erl
concuerror_console -f foo.beam
good
rm foo.beam

testing "Bad BEAM input file"
rm -f foo.beam
cp foo.erl foo.beam
! concuerror_console -f foo.beam
consolehas "Error:"
rm foo.beam

. footer
